{% extends "base.html" %}

{% block title %}Payroll Report - {{ month_display }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Payroll Report - {{ month_display }}</h1>
    </div>

    <!-- Filter -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-8">
                    <label for="month" class="form-label fw-600"
                        style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; color: #555;">
                        <i class="fas fa-calendar-alt"></i> Select Month
                    </label>
                    <input type="month" class="form-control form-control-lg" id="month" name="month"
                        value="{{ month }}">
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-sync"></i> Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title">Total Employees</h6>
                    <h3>{{ salary_records|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title">Total Gross Salary</h6>
                    <h3>₹ {{ "%.0f"|format(total_gross) }}</h3>
                    <small class="text-muted">All employees</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title">Total Net Salary</h6>
                    <h3>₹ {{ "%.0f"|format(total_net) }}</h3>
                    <small class="text-muted">After deductions & tax</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-title">Total Paid</h6>
                    <h3>₹ {{ "%.0f"|format(total_paid) }}</h3>
                    <small class="text-muted">Paid salaries</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Details -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <strong>Total Bonus</strong><br>
                    <h4>₹ {{ "%.2f"|format(total_bonus) }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <strong>Total Deductions</strong><br>
                    <h4>₹ {{ "%.2f"|format(total_deductions) }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <strong>Total Tax</strong><br>
                    <h4>₹ {{ "%.2f"|format(total_tax) }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <strong>Pending Payment</strong><br>
                    <h4>₹ {{ "%.2f"|format(total_net - total_paid) }}</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Payroll Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Employee-wise Payroll Details</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Gross</th>
                        <th>Bonus</th>
                        <th>Deductions</th>
                        <th>Tax</th>
                        <th>Net Salary</th>
                        <th>Paid</th>
                        <th>Pending</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% if salary_records %}
                    {% for salary in salary_records %}
                    <tr>
                        <td><strong>{{ salary.employee.employee_id }}</strong></td>
                        <td>{{ salary.employee.get_full_name() }}</td>
                        <td>{{ salary.employee.department }}</td>
                        <td>₹ {{ "%.2f"|format(salary.gross_salary) }}</td>
                        <td>
                            {% if salary.bonus > 0 %}
                            <span class="text-success">₹ {{ "%.2f"|format(salary.bonus) }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if salary.deductions > 0 %}
                            <span class="text-warning">₹ {{ "%.2f"|format(salary.deductions) }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if salary.tax > 0 %}
                            <span class="text-danger">₹ {{ "%.2f"|format(salary.tax) }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td><strong>₹ {{ "%.2f"|format(salary.net_salary) }}</strong></td>
                        <td class="text-success">₹ {{ "%.2f"|format(salary.amount_paid or 0) }}</td>
                        <td class="text-danger">₹ {{ "%.2f"|format(salary.pending_amount or 0) }}</td>
                        <td>
                            <span
                                class="badge {% if salary.payment_status == 'paid' %}bg-success{% elif salary.payment_status == 'pending' %}bg-warning{% else %}bg-info{% endif %}">
                                {{ salary.payment_status.capitalize() }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            No salary records found for {{ month_display }}.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="3">TOTAL</th>
                        <th>₹ {{ "%.2f"|format(total_gross) }}</th>
                        <th>₹ {{ "%.2f"|format(total_bonus) }}</th>
                        <th>₹ {{ "%.2f"|format(total_deductions) }}</th>
                        <th>₹ {{ "%.2f"|format(total_tax) }}</th>
                        <th><strong>₹ {{ "%.2f"|format(total_net) }}</strong></th>
                        <th>₹ {{ "%.2f"|format(total_paid or 0) }}</th>
                        <th>₹ {{ "%.2f"|format((total_net or 0) - (total_paid or 0)) }}</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Print Button -->
    <div class="mt-4 text-center">
        <button onclick="window.print()" class="btn btn-secondary">
            <i class="fas fa-print"></i> Print Report
        </button>
    </div>
</div>

<style>
    @media print {

        /* Hide non-print elements */
        .sidebar,
        header,
        .btn,
        .card:has(form),
        .nav-link,
        .flashes {
            display: none !important;
        }

        /* Adjust main content for print */
        .main-content {
            margin-left: 0 !important;
            padding: 20px !important;
            width: 100% !important;
        }

        /* Ensure cards look good on paper */
        .card {
            border: 1px solid #ddd !important;
            box-shadow: none !important;
            margin-bottom: 20px !important;
            break-inside: avoid;
        }

        .card-header {
            background-color: #f8f9fa !important;
            color: #000 !important;
            border-bottom: 1px solid #ddd !important;
        }

        /* Reset colors for clarity */
        body {
            background: white !important;
            color: black !important;
        }

        .table {
            color: black !important;
        }

        .badge {
            border: 1px solid #000 !important;
            color: #000 !important;
            background: transparent !important;
        }

        h1,
        h3,
        h4,
        h5,
        h6 {
            color: #000 !important;
            margin-top: 10px !important;
        }

        .bg-success,
        .bg-warning,
        .bg-danger,
        .bg-info {
            background-color: transparent !important;
            color: black !important;
            border: 1px solid #ddd !important;
        }
    }
</style>
{% endblock %}
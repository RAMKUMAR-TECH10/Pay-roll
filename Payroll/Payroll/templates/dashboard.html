{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block header %}Overview{% endblock %}

{% block content %}
<!-- Quick Stats Banner -->
<div
    style="background: linear-gradient(90deg, var(--accent-color), #88c1ff); padding: 2px; border-radius: 16px; margin-bottom: 30px;">
    <div
        style="background: var(--bg-color); border-radius: 15px; padding: 20px; display: flex; justify-content: space-around; align-items: center;">
        <div style="text-align: center;">
            <div style="color: #8b949e; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">Active Since
            </div>
            <div style="font-weight: bold; font-size: 1.1rem;">Feb 2026</div>
        </div>
        <div style="width: 1px; height: 30px; background: var(--border-color);"></div>
        <div style="text-align: center;">
            <div style="color: #8b949e; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">System Status
            </div>
            <div style="font-weight: bold; font-size: 1.1rem; color: var(--success-color);">‚óè Operational</div>
        </div>
        <div style="width: 1px; height: 30px; background: var(--border-color);"></div>
        <div style="text-align: center;">
            <div style="color: #8b949e; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">Currency
            </div>
            <div style="font-weight: bold; font-size: 1.1rem;">INR (‚Çπ)</div>
        </div>
    </div>
</div>

<!-- Production Stats -->
<div class="grid-container">
    <div class="card">
        <h3>Production Today</h3>
        <div class="value">{{ production_today }} <span style="font-size: 0.5em; opacity: 0.7;">Bundles</span></div>
    </div>
</div>

{% if profit_overview and current_user.role == 'admin' %}
<!-- Admin-Only: Profit Overview Cards -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
    <!-- Today's Profit -->
    <div class="card" style="border-left: 4px solid #22c55e;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 0.9rem; color: #8b949e;">Today's Profit</h3>
            <span style="font-size: 1.2rem;">üí∞</span>
        </div>
        <div
            style="font-size: 1.8rem; font-weight: 700; color: {% if profit_overview.today.profit >= 0 %}#22c55e{% else %}#ef4444{% endif %};">
            ‚Çπ{{ profit_overview.today.profit }}
        </div>
        <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">
            Revenue: ‚Çπ{{ profit_overview.today.revenue }} | Cost: ‚Çπ{{ profit_overview.today.cost }}
        </div>
    </div>

    <!-- Weekly Profit -->
    <div class="card" style="border-left: 4px solid #3b82f6;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 0.9rem; color: #8b949e;">This Week's Profit</h3>
            <span style="font-size: 1.2rem;">üìà</span>
        </div>
        <div
            style="font-size: 1.8rem; font-weight: 700; color: {% if profit_overview.week.profit >= 0 %}#22c55e{% else %}#ef4444{% endif %};">
            ‚Çπ{{ profit_overview.week.profit }}
        </div>
        <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">
            Revenue: ‚Çπ{{ profit_overview.week.revenue }} | Cost: ‚Çπ{{ profit_overview.week.cost }}
        </div>
    </div>

    <!-- Monthly Profit -->
    <div class="card" style="border-left: 4px solid #f59e0b;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 0.9rem; color: #8b949e;">This Month's Profit</h3>
            <span style="font-size: 1.2rem;">üèÜ</span>
        </div>
        <div
            style="font-size: 1.8rem; font-weight: 700; color: {% if profit_overview.month.profit >= 0 %}#22c55e{% else %}#ef4444{% endif %};">
            ‚Çπ{{ profit_overview.month.profit }}
        </div>
        <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">
            Revenue: ‚Çπ{{ profit_overview.month.revenue }} | Cost: ‚Çπ{{ profit_overview.month.cost }}
        </div>
    </div>
</div>

<!-- Admin: Selling Price Info -->
<div
    style="background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 12px; padding: 15px 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <span style="color: #f59e0b; font-weight: 600;">Selling Price:</span>
        <span style="color: #e2e8f0; font-weight: 700; font-size: 1.1rem;"> ‚Çπ{{ profit_overview.selling_price }} per
            bundle</span>
        <span style="color: #64748b; font-size: 0.85rem; margin-left: 10px;">(Change in Analytics page)</span>
    </div>
    <a href="{{ url_for('main.analytics') }}" style="color: #f59e0b; text-decoration: none; font-size: 0.85rem;">View
        Full Analytics ‚Üí</a>
</div>
{% endif %}

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 40px;">
    <div class="card">
        <h3>Weekly Production Trend</h3>
        <canvas id="productionChart" style="max-height: 300px;"></canvas>
    </div>
    <div class="card">
        <h3>Raw Material Status</h3>
        <div style="max-height: 300px; overflow-y: auto;">
            <table style="margin-top: 0; width: 100%; font-size: 0.9rem;">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Stock</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for material in raw_materials %}
                    <tr>
                        <td>{{ material.name }}</td>
                        <td>{{ material.quantity }} {{ material.unit }}</td>
                        <td>
                            {% if material.quantity < 20 %} <span class="badge badge-danger">Low Stock</span>
                                {% else %}
                                <span class="badge badge-success">Good</span>
                                {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if low_stock_materials %}
<div class="card" style="border-left: 4px solid #ef4444; margin-bottom: 30px;">
    <h3 style="color: #ef4444;">‚ö†Ô∏è Low Stock Alerts</h3>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        {% for material in low_stock_materials %}
        <div
            style="background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; padding: 10px 15px;">
            <div style="font-weight: 600; color: #ef4444;">{{ material.name }}</div>
            <div style="font-size: 0.85rem; color: #94a3b8;">{{ material.quantity }} {{ material.unit }} remaining</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
    const ctx = document.getElementById('productionChart').getContext('2d');
    const chartData = {
        labels: [{% for item in weekly_production %}"{{ item.day }}"{% if not loop.last %}, {% endif %} {% endfor %}],
    datasets: [{
        label: 'Bundles Produced',
        data: [{% for item in weekly_production %}{{ item.total }}{% if not loop.last %}, {% endif %} {% endfor %}],
    borderColor: '#58a6ff',
        backgroundColor: 'rgba(88, 166, 255, 0.1)',
            borderWidth: 3,
                fill: true,
                    tension: 0.4,
                        pointBackgroundColor: '#58a6ff',
                            pointRadius: 4
        }]
    };

    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#8b949e' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#8b949e' }
                }
            }
        }
    });
</script>
{% endblock %}